/**
 *Author : www.juliocanares.com/cv
 *Email : juliocanares@gmail.com
 */
var APP = APP || {};

APP.BaseElement = function (data, id) {
    this.template = _.template(APP.TemplateManager.instance.templates[id]);
    this.data = data;
    this.view = $(this.template(this.data));
    this.rawView = this.view[0];

    this.setupUI();
    this.listeners();
};

APP.BaseElement.prototype = Object.create(Object.prototype);

APP.BaseElement.constructor = APP.BaseElement;

APP.BaseElement.prototype.setupUI = function () {

}


APP.BaseElement.prototype.listeners = function () {

};

APP.BaseElement.prototype.gotoSingle = function () {
    location.href = this.data.url;
};

APP.BaseElement.prototype.callToApi = function (params) {
    return APP.RestClientManager.instance.execute(params);
}

APP.BaseElement.prototype.checkLogged = function () {
    if (!user)
        return location.href = DataApp.loginRedirect;
}

/**
 *Author : www.juliocanares.com/cv
 *Email : juliocanares@gmail.com
 */
var APP = APP || {};

APP.BaseScreen = function (id) {
    this.id = id;
};

APP.BaseScreen.prototype = Object.create(Object.prototype);

APP.BaseScreen.constructor = APP.BaseScreen;


APP.BaseScreen.prototype.listeners = function () {

};

APP.BaseScreen.prototype.beforeFind = function () {

};

APP.BaseScreen.prototype.afterFind = function () {

};

APP.BaseScreen.prototype.clean = function () {

};

APP.BaseScreen.prototype.getData = function (params) {
    return APP.RestClientManager.instance.execute(params);
}
/**
 *Author : www.juliocanares.com/cv
 *Email : juliocanares@gmail.com
 */
var APP = APP || {};

APP.Collection = function (data) {
    APP.BaseElement.call(this, data, 'collection');
};

APP.Collection.prototype = Object.create(APP.BaseElement.prototype);

APP.Collection.constructor = APP.Collection;

APP.Collection.prototype.setupUI = function () {

};

APP.Collection.prototype.listeners = function () {

};
/**
 *Author : www.juliocanares.com/cv
 *Email : juliocanares@gmail.com
 */
var APP = APP || {};

APP.Product = function (data) {
    APP.BaseElement.call(this, data, 'product');
    this.liked = this.data.liked;
};

APP.Product.prototype = Object.create(APP.BaseElement.prototype);

APP.Product.constructor = APP.Product;

APP.Product.prototype.setupUI = function () {
    if (Utils.isMobile.any()) {
        /*
         this.likeBtn = this.view.find('.social-item');
         this.collectBtn = this.view.find('.social-item');
         */
    }
};

APP.Product.prototype.listeners = function () {/*
    this.likeBtn.click(this.likeToggle.bind(this));
    this.view.click(this.gotoSingle.bind(this));*/
};

APP.Product.prototype.likeToggle = function (event) {
    this.checkLogged();

    var params = {
        data: {idProduct: this.data.id},
        url: DataApp[!this.liked ? 'productLike' : 'productUnLike']
    };

    this.callToApi(params).done(this.afterLikeApi.bind(this));

    if (event.stopPropagation)
        event.stopPropagation();
};

APP.Product.prototype.afterLikeApi = function (data) {
    if (data.status === 200) {
        if (Utils.isMobile.any())
            this.likeBtn.toggleClass('fade');
        else
            this.likeBtn.toggleClass('active');
        this.liked = !this.liked;
    }
};
/**
 *Author : www.juliocanares.com/cv
 *Email : juliocanares@gmail.com
 */
var APP = APP || {};

APP.User = function (data) {
    APP.BaseElement.call(this, data, 'user');
    this.following = this.data.following;
    this.likes = this.data.likes;


};

APP.User.prototype = Object.create(APP.BaseElement.prototype);

APP.User.constructor = APP.User;

APP.User.prototype.setupUI = function () {
};

APP.User.prototype.listeners = function () {

};
/**
 *Author : www.juliocanares.com/cv
 *Email : juliocanares@gmail.com
 */
var APP = APP || {};

APP.Work = function (data) {
    APP.BaseElement.call(this, data, 'work');
    this.liked = this.data.liked;
};

APP.Work.prototype = Object.create(APP.BaseElement.prototype);

APP.Work.constructor = APP.Work;

APP.Work.prototype.setupUI = function () {
    this.hammer = new Hammer.Manager(this.rawView);
    this.hammer.add(new Hammer.Tap({event: 'doubletap', taps: 2}));
    this.hammer.add(new Hammer.Tap({event: 'singletap'}));
    this.hammer.get('doubletap').recognizeWith('singletap');
    this.hammer.get('singletap').requireFailure('doubletap');

    this.likeBtn = this.view.find('.social-item');
};

APP.Work.prototype.listeners = function () {
    if (Utils.isMobile.any()) {
        this.hammer.on("singletap", this.gotoSingle.bind(this));
        this.hammer.on("doubletap", this.likeToggle.bind(this));
    } else {
        this.likeBtn.click(this.likeToggle.bind(this));
        this.view.click(this.gotoSingle.bind(this));
    }
};

APP.Work.prototype.likeToggle = function (event) {
    this.checkLogged();

    var params = {
        data: {idWork: this.data.id},
        url: DataApp[!this.liked ? 'workLike' : 'workUnLike']
    };

    this.callToApi(params).done(this.afterLikeApi.bind(this));

    if (event.stopPropagation)
        event.stopPropagation();
};

APP.Work.prototype.afterLikeApi = function (data) {
    if (data.status === 200) {
        if (Utils.isMobile.any())
            this.likeBtn.toggleClass('fade');
        else
            this.likeBtn.toggleClass('active');
        this.liked = !this.liked;
    }
};
/**
 * @author www.juliocanares.com/cv
 * @email juliocanares@gmail.com
 */

DataApp = {};

DataApp.baseUrl = 'http://127.0.0.1:3000/';
DataApp.templatesUrl = DataApp.baseUrl + 'resources/templates/';

DataApp.loginUrl = DataApp.baseUrl + 'auth/login';

DataApp.searchUrl = DataApp.baseUrl + 'search/';
DataApp.searchWorks = DataApp.searchUrl + 'works/category/all/page-1/';
DataApp.searchUsers = DataApp.searchUrl + 'users/specialties/all/page-1/';
DataApp.searchProducts = DataApp.searchUrl + 'products/type/all/page-1/';

DataApp.workLike = DataApp.baseUrl + user.username + '/work/like';
DataApp.workUnLike = DataApp.baseUrl + user.username + '/work/unlike';

DataApp.productLike = DataApp.baseUrl + user.username + '/work/like';
DataApp.productUnLike = DataApp.baseUrl + user.username + '/work/unlike';

DataApp.searchCollections = DataApp.baseUrl + 'artjam/collections/page-1';

DataApp.loginRedirect = '/auth/login/?returnTo=' + location.href;
/**
 *Author : www.juliocanares.com/cv
 *Email : juliocanares@gmail.com
 */
var APP = APP || {};

APP.PaginableScreen = function (id, navigation) {
    APP.BaseScreen.call(this, id);

    APP.PaginableScreen.NAVIGATION_PAGINATION = 'pagination';
    APP.PaginableScreen.NAVIGATION_INFINITE = 'infinite';

    this.navigation = navigation || APP.PaginableScreen.NAVIGATION_PAGINATION;

    this.container = $('.' + this.id);
    this.rawContainer = this.container[0];

    this.url;
    this.currentPage = 0;
    this.totalPages = 0;

    this.maxButtons = 7;

    this.pagesCache = {};
    this.currentPageData;

    this.listeners();
};

APP.PaginableScreen.prototype = Object.create(APP.BaseScreen.prototype);

APP.PaginableScreen.constructor = APP.PaginableScreen;

APP.PaginableScreen.prototype.listeners = function () {
    if (this.navigation === APP.PaginableScreen.NAVIGATION_PAGINATION)
        $(document).on('click', '.page-button', this.pagesHandler.bind(this));
};

APP.PaginableScreen.prototype.pagesHandler = function (event) {
    event.preventDefault();
    var buttonPage = $(event.currentTarget).attr('id');
    this.gotoPage(buttonPage);
};

APP.PaginableScreen.prototype.gotoPage = function (next) {
    var nextPage = next || this.currentPage + 1;

    if (this.currentPage === nextPage)return;
    if (this.currentPage === 0)this.currentPage = 1;

    this.url = this.getUrlOfNewPage(nextPage);

    if (this.pagesCache[nextPage])
        return this.afterGetData(this.pagesCache[nextPage]);

    this.getData({url: this.url}).done(this.afterGetData.bind(this));
};

APP.PaginableScreen.prototype.afterGetData = function (response) {
    this.currentPage = response.pagination.page;
    this.totalPages = response.pagination.pages;

    if (this.currentPage > response.pagination.pages)return;

    this.pagesCache[this.currentPage] = response;
    this.currentPageData = response;

    this.build();
}

APP.PaginableScreen.prototype.build = function () {
    if (this.navigation === APP.PaginableScreen.NAVIGATION_PAGINATION)
        this.makeButtons();
};

APP.PaginableScreen.prototype.makeButtons = function () {
    var numbers = Utils.paginationButtons(this.currentPage, this.totalPages,
        this.maxButtons);
    //TODO make buttons view
};

APP.PaginableScreen.prototype.getUrlOfNewPage = function (newPage) {
    return this.url.replace('page-' + this.currentPage, 'page-' + newPage);
};

APP.PaginableScreen.prototype.clean = function () {

};
/**
 *Author : www.juliocanares.com/cv
 *Email : juliocanares@gmail.com
 */
var APP = APP || {};

APP.ProductsScreen = function (data) {
    APP.PaginableScreen.call(this);
    
    this.url = DataApp.searchProducts;
};

APP.ProductsScreen.prototype = Object.create(APP.PaginableScreen.prototype);

APP.ProductsScreen.constructor = APP.ProductsScreen;
/**
 * Created by juliocanares on 5/28/15.
 */

/**
 *Author : www.juliocanares.com/cv
 *Email : juliocanares@gmail.com
 */
var APP = APP || {};

APP.WorksScreen = function () {
    APP.PaginableScreen.call(this, 'works', APP.PaginableScreen.NAVIGATION_PAGINATION);

    this.url = DataApp.searchWorks;
};

APP.WorksScreen.prototype = Object.create(APP.PaginableScreen.prototype);

APP.WorksScreen.constructor = APP.WorksScreen;

APP.WorksScreen.prototype.build = function () {
    APP.PaginableScreen.prototype.build.call(this);

    if (this.navigation === APP.PaginableScreen.NAVIGATION_PAGINATION)
        this.clean();

    var i, work;
    for (i = 0; i < this.currentPageData.works.length; i++) {
        this.currentPageData.works[i].index = i + 1;
        work = new APP.Work(this.currentPageData.works[i]);
        salvattore.appendElements(this.rawContainer, [work.rawView]);
    }
};

APP.WorksScreen.prototype.clean = function () {
    $('.work').remove();
};
/**
 *Author : www.juliocanares.com/cv
 *Email : juliocanares@gmail.com
 */
var APP = APP || {};

APP.RestClientManager = function () {
    APP.RestClientManager.instance = this;
};

APP.RestClientManager.prototype = Object.create(Object.prototype);

APP.RestClientManager.constructor = APP.RestClientManager;

APP.RestClientManager.prototype.execute = function (config) {
    config.method = config.method || 'post';
    return $.ajax(config);
}
/**
 *Author : www.juliocanares.com/cv
 *Email : juliocanares@gmail.com
 */
var APP = APP || {};

APP.TemplateManager = function () {
    APP.TemplateManager.instance = this;
    this.templates = {};
};

APP.TemplateManager.prototype = Object.create(Object.prototype);

APP.TemplateManager.constructor = APP.TemplateManager;

APP.TemplateManager.prototype.loadTemplates = function (ids) {
    var scope = this, i, deferreds = [];
    for (i = 0; i < ids.length; i++)
        deferreds.push($.get(DataApp.templatesUrl + ids[i] + ".html"));

    return $.when.apply(null, deferreds).done(function () {
        if (ids.length <= 1) return scope.templates[ids[0]] = arguments[0];
        for (i = 0; i < ids.length; i++)
            scope.templates[ids[i]] = arguments[i][0];
    });
};
/**
 * @author www.juliocanares.com/cv
 * @email juliocanares@gmail.com
 */
Utils = {
    isMobile: {
        Android: function () {
            return navigator.userAgent.match(/Android/i);
        },
        BlackBerry: function () {
            return navigator.userAgent.match(/BlackBerry/i);
        },
        iOS: function () {
            return navigator.userAgent.match(/iPhone|iPad|iPod/i);
        },
        Opera: function () {
            return navigator.userAgent.match(/Opera Mini/i);
        },
        Windows: function () {
            return navigator.userAgent.match(/IEMobile/i);
        },
        any: function () {
            return (Utils.isMobile.Android() || Utils.isMobile.BlackBerry() ||
            Utils.isMobile.iOS() || Utils.isMobile.Opera() || Utils.isMobile.Windows());
        }
    },
    paginationButtons: function (currentPage, totalPages, maxButtons) {
        var i, result = [1], middle = Math.floor(maxButtons / 2);

        if (currentPage > totalPages)
            return null;

        if (totalPages < maxButtons) {
            for (i = 2; i < totalPages + 1; i++)
                result.push(i);
            return result;
        }

        if (currentPage <= middle && currentPage > 0)
            for (i = 2; i < maxButtons; i++)
                result.push(i);

        var maxLimit = (totalPages - middle);

        if (currentPage > middle && currentPage < maxLimit) {
            var steps = ((maxButtons - 3) / 2);
            for (i = currentPage - steps; i < currentPage + steps + 1; i++)
                result.push(i);
        }

        if (currentPage >= maxLimit && currentPage <= totalPages) {
            for (i = (totalPages - (maxButtons - 2) ); i < totalPages; i++)
                result.push(i);
        }

        result.push(totalPages);
        return result;
    }
}
