/**
 *Author : www.juliocanares.com/cv
 *Email : juliocanares@gmail.com
 */
var APP = APP || {};

APP.BaseElement = function (data, id) {
    this.template = _.template(APP.TemplateManager.instance.templates[id]);
    this.data = data;
    this.view = $(this.template(this.data));
    this.rawView = this.view[0];

    this.setupUI();
    this.listeners();
};

APP.BaseElement.prototype = Object.create(Object.prototype);

APP.BaseElement.constructor = APP.BaseElement;

APP.BaseElement.prototype.setupUI = function () {

}


APP.BaseElement.prototype.listeners = function () {

};

APP.BaseElement.prototype.gotoSingle = function () {
    location.href = this.data.url;
};

APP.BaseElement.prototype.callToApi = function (params) {
    return APP.RestClientManager.instance.execute(params);
}

APP.BaseElement.prototype.checkLogged = function () {
    if (!user)
        return location.href = DataApp.loginRedirect;
}

/**
 *Author : www.juliocanares.com/cv
 *Email : juliocanares@gmail.com
 */
var APP = APP || {};

APP.BaseScreen = function () {

};

APP.BaseScreen.prototype = Object.create(Object.prototype);

APP.BaseScreen.constructor = APP.BaseScreen;

APP.BaseScreen.prototype.beforeFind = function () {

}

APP.BaseScreen.prototype.afterFind = function () {

}

APP.BaseScreen.prototype.getDataByAjax = function (config, method, callback) {
    APP.RestClientManager.instance.execute(config, method, callback);
}
/**
 *Author : www.juliocanares.com/cv
 *Email : juliocanares@gmail.com
 */
var APP = APP || {};

APP.RestClientManager = function () {
    APP.RestClientManager.instance = this;
};

APP.RestClientManager.prototype = Object.create(Object.prototype);

APP.RestClientManager.constructor = APP.RestClientManager;

APP.RestClientManager.prototype.execute = function (config) {
    config.method = config.method || 'post';
    return $.ajax(config);
}
/**
 *Author : www.juliocanares.com/cv
 *Email : juliocanares@gmail.com
 */
var APP = APP || {};

APP.TemplateManager = function () {
    APP.TemplateManager.instance = this;
    this.templates = {};
};

APP.TemplateManager.prototype = Object.create(Object.prototype);

APP.TemplateManager.constructor = APP.TemplateManager;

APP.TemplateManager.prototype.loadTemplates = function (ids) {
    var scope = this, i, deferreds = [];
    for (i = 0; i < ids.length; i++)
        deferreds.push($.get(DataApp.templatesUrl + ids[i] + ".html"));

    return $.when.apply(null, deferreds).done(function () {
        if (ids.length <= 1) return scope.templates[ids[0]] = arguments[0];
        for (i = 0; i < ids.length; i++)
            scope.templates[ids[i]] = arguments[i][0];
    });
};
/**
 * @author www.juliocanares.com/cv
 * @email juliocanares@gmail.com
 */

DataApp = {};

DataApp.baseUrl = 'http://127.0.0.1:3000/';
DataApp.templatesUrl = DataApp.baseUrl + 'resources/templates/';

DataApp.loginUrl = DataApp.baseUrl + 'auth/login';

DataApp.searchUrl = DataApp.baseUrl + 'search/';
DataApp.searchWorks = DataApp.searchUrl + 'works/category/all/page-1/';
DataApp.searchUsers = DataApp.searchUrl + 'users/specialties/all/page-1/';
DataApp.searchProducts = DataApp.searchUrl + 'products/type/all/page-1/';

DataApp.workLike = DataApp.baseUrl + user.username + '/work/like';
DataApp.workUnLike = DataApp.baseUrl + user.username + '/work/unlike';

DataApp.productLike = DataApp.baseUrl + user.username + '/work/like';
DataApp.productUnLike = DataApp.baseUrl + user.username + '/work/unlike';

DataApp.searchCollections = DataApp.baseUrl + 'artjam/collections/page-1';

DataApp.loginRedirect = '/auth/login/?returnTo=' + location.href;

Utils = {
    isMobile: {
        Android: function () {
            return navigator.userAgent.match(/Android/i);
        },
        BlackBerry: function () {
            return navigator.userAgent.match(/BlackBerry/i);
        },
        iOS: function () {
            return navigator.userAgent.match(/iPhone|iPad|iPod/i);
        },
        Opera: function () {
            return navigator.userAgent.match(/Opera Mini/i);
        },
        Windows: function () {
            return navigator.userAgent.match(/IEMobile/i);
        },
        any: function () {
            return (Utils.isMobile.Android() || Utils.isMobile.BlackBerry() ||
            Utils.isMobile.iOS() || Utils.isMobile.Opera() || Utils.isMobile.Windows());
        }
    }
}
/**
 *Author : www.juliocanares.com/cv
 *Email : juliocanares@gmail.com
 */
var APP = APP || {};

APP.PaginableScreen = function (type) {
    this.type = type || 'numbers';
    this.url = '';
    this.container;
    this.currentPage = 0;
    this.totalPages = 0;
    this.data = {};
    this.maxButtons = 7;
    this.currentPageData;
};

APP.PaginableScreen.prototype = Object.create(APP.BaseScreen.prototype);

APP.PaginableScreen.constructor = APP.PaginableScreen;

APP.PaginableScreen.prototype.gotoPage = function (next) {
    var scope = this;
    var nextPage = next || scope.currentPage + 1;

    if (this.currentPage === nextPage)return;
    if (this.currentPage === 0)this.currentPage = 1;

    scope.url = scope.url.replace('page-' + scope.currentPage, 'page-' + nextPage);

    return $.post(scope.url).then(function (data) {
        console.log(data);
        scope.currentPage = data.pagination.page;
        scope.totalPages = data.pagination.pages;

        if(scope.currentPage > data.pagination.pages)return;

        scope.data[scope.currentPage] = data;
        scope.currentPageData = data;

        scope.build();
        scope.makeButtons();
    });
}

APP.PaginableScreen.prototype.build = function () {

}
APP.PaginableScreen.prototype.makeButtons = function () {
    $('.content').remove();
    var numbers = this.generateNumbers();
    var i, number, pNumber, content = $('<div>', {class: 'content'});
    for (i = 0; i < numbers.length; i++) {
        number = numbers[i];
        pNumber = $('<a>').text(number);
        pNumber.css('padding', '10px');
        if (number === this.currentPage)
            pNumber.css('color', '#ff0000');
        content.append(pNumber);
    }
    this.container.append(content);
}

APP.PaginableScreen.prototype.generateNumbers = function () {
    var i, result = [1], middle = Math.floor(this.maxButtons / 2);

    if (this.currentPage > this.totalPages)
        return null;

    if (this.totalPages < this.maxButtons) {
        for (i = 2; i < this.totalPages + 1; i++)
            result.push(i);
        return result;
    }

    if (this.currentPage <= middle && this.currentPage > 0)
        for (i = 2; i < this.maxButtons; i++)
            result.push(i);

    var maxLimit = (this.totalPages - middle);

    if (this.currentPage > middle && this.currentPage < maxLimit) {
        var steps = ((this.maxButtons - 3) / 2);
        for (i = this.currentPage - steps; i < this.currentPage + steps + 1; i++)
            result.push(i);
    }

    if (this.currentPage >= maxLimit && this.currentPage <= this.totalPages) {
        for (i = (this.totalPages - (this.maxButtons - 2) ); i < this.totalPages; i++)
            result.push(i);
    }

    result.push(this.totalPages);
    return result;
}
/**
 *Author : www.juliocanares.com/cv
 *Email : juliocanares@gmail.com
 */
var APP = APP || {};

APP.ProductsScreen = function (data) {
    APP.PaginableScreen.call(this);
    
    this.url = DataApp.searchProducts;
};

APP.ProductsScreen.prototype = Object.create(APP.PaginableScreen.prototype);

APP.ProductsScreen.constructor = APP.ProductsScreen;
/**
 * Created by juliocanares on 5/28/15.
 */

/**
 *Author : www.juliocanares.com/cv
 *Email : juliocanares@gmail.com
 */
var APP = APP || {};

APP.WorksScreen = function () {
    APP.PaginableScreen.call(this, 'numbers');
    this.container = $('.works')
    this.rawContainer = this.container[0];

    this.url = DataApp.searchWorks;
};

APP.WorksScreen.prototype = Object.create(APP.PaginableScreen.prototype);

APP.WorksScreen.constructor = APP.WorksScreen;

APP.WorksScreen.prototype.build = function () {
    if (this.type === 'numbers')
        $('.work').remove();
    
    var i, work;
    for (i = 0; i < this.currentPageData.works.length; i++) {
        this.currentPageData.works[i].index = i + 1;
        work = new APP.Work(this.currentPageData.works[i]);
        salvattore.appendElements(this.rawContainer, [work.rawView]);
    }
}
/**
 *Author : www.juliocanares.com/cv
 *Email : juliocanares@gmail.com
 */
var APP = APP || {};

APP.Collection = function (data) {
    APP.BaseElement.call(this, data, 'collection');
};

APP.Collection.prototype = Object.create(APP.BaseElement.prototype);

APP.Collection.constructor = APP.Collection;

APP.Collection.prototype.setupUI = function () {

};

APP.Collection.prototype.listeners = function () {

};
/**
 *Author : www.juliocanares.com/cv
 *Email : juliocanares@gmail.com
 */
var APP = APP || {};

APP.Product = function (data) {
    APP.BaseElement.call(this, data, 'product');
    this.liked = this.data.liked;
};

APP.Product.prototype = Object.create(APP.BaseElement.prototype);

APP.Product.constructor = APP.Product;

APP.Product.prototype.setupUI = function () {
    if (Utils.isMobile.any()) {
        /*
         this.likeBtn = this.view.find('.social-item');
         this.collectBtn = this.view.find('.social-item');
         */
    }
};

APP.Product.prototype.listeners = function () {/*
    this.likeBtn.click(this.likeToggle.bind(this));
    this.view.click(this.gotoSingle.bind(this));*/
};

APP.Product.prototype.likeToggle = function (event) {
    this.checkLogged();

    var params = {
        data: {idProduct: this.data.id},
        url: DataApp[!this.liked ? 'productLike' : 'productUnLike']
    };

    this.callToApi(params).done(this.afterLikeApi.bind(this));

    if (event.stopPropagation)
        event.stopPropagation();
};

APP.Product.prototype.afterLikeApi = function (data) {
    if (data.status === 200) {
        if (Utils.isMobile.any())
            this.likeBtn.toggleClass('fade');
        else
            this.likeBtn.toggleClass('active');
        this.liked = !this.liked;
    }
};
/**
 *Author : www.juliocanares.com/cv
 *Email : juliocanares@gmail.com
 */
var APP = APP || {};

APP.User = function (data) {
    APP.BaseElement.call(this, data, 'user');
    this.following = this.data.following;
    this.likes = this.data.likes;


};

APP.User.prototype = Object.create(APP.BaseElement.prototype);

APP.User.constructor = APP.User;

APP.User.prototype.setupUI = function () {
};

APP.User.prototype.listeners = function () {

};
/**
 *Author : www.juliocanares.com/cv
 *Email : juliocanares@gmail.com
 */
var APP = APP || {};

APP.Work = function (data) {
    APP.BaseElement.call(this, data, 'work');
    this.liked = this.data.liked;
};

APP.Work.prototype = Object.create(APP.BaseElement.prototype);

APP.Work.constructor = APP.Work;

APP.Work.prototype.setupUI = function () {
    this.hammer = new Hammer.Manager(this.rawView);
    this.hammer.add(new Hammer.Tap({event: 'doubletap', taps: 2}));
    this.hammer.add(new Hammer.Tap({event: 'singletap'}));
    this.hammer.get('doubletap').recognizeWith('singletap');
    this.hammer.get('singletap').requireFailure('doubletap');

    this.likeBtn = this.view.find('.social-item');
};

APP.Work.prototype.listeners = function () {
    if (Utils.isMobile.any()) {
        this.hammer.on("singletap", this.gotoSingle.bind(this));
        this.hammer.on("doubletap", this.likeToggle.bind(this));
    } else {
        this.likeBtn.click(this.likeToggle.bind(this));
        this.view.click(this.gotoSingle.bind(this));
    }
};

APP.Work.prototype.likeToggle = function (event) {
    this.checkLogged();

    var params = {
        data: {idWork: this.data.id},
        url: DataApp[!this.liked ? 'workLike' : 'workUnLike']
    };

    this.callToApi(params).done(this.afterLikeApi.bind(this));

    if (event.stopPropagation)
        event.stopPropagation();
};

APP.Work.prototype.afterLikeApi = function (data) {
    if (data.status === 200) {
        if (Utils.isMobile.any())
            this.likeBtn.toggleClass('fade');
        else
            this.likeBtn.toggleClass('active');
        this.liked = !this.liked;
    }
};