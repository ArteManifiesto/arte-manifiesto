<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Creator</title>
    <link rel="stylesheet" href="/demo.css">
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/medium-editor/latest/css/medium-editor.min.css">
    <link rel="stylesheet" href="/default.css">
    <link rel="stylesheet" href="/medium-editor-insert-plugin.css">
    <style>
  	.hide {
  		display: none;
  	}
  	.cloudinary-fileupload
  {
  	border: none;
  	cursor: pointer;
  	opacity: 0;
  	padding: 0;
  	position: absolute;
  	top: 0;
  }
  	</style>
</head>
<body>

<p>
  status : <span class="status">Inicio</span>
</p>
<div id="container">
    {{ cloudinary.uploader.image_upload_tag('photo', {callback: cloudinary_cors, return_delete_token: true, html: {
    style: "width:230px;height:55px;top:-70px;left: 105px;" } })}}

    <div class="editable">
      {% if post %}
        {{post.body|safe}}
      {% endif %}
    </div>
</div>

<script src="/jquery-2.1.1.min.js"></script>
<script src="http://linkesch.com/medium-editor-insert-plugin/bower_components/handlebars/handlebars.runtime.min.js"></script>
<script src="http://linkesch.com/medium-editor-insert-plugin/bower_components/jquery-sortable/source/js/jquery-sortable-min.js"></script>

<script src='/jquery.ui.widget.js'></script>
<script src='/jquery.iframe-transport.js'></script>
<script src='/jquery.fileupload.js'></script>
<script src='/jquery.cloudinary.js'></script>
<script src='/broadcaster.js'></script>

<script src="//cdn.jsdelivr.net/medium-editor/latest/js/medium-editor.min.js"></script>
<script src="/medium-editor-insert-plugin.js"></script>

<script>
    var Events = {
        CREATOR_READY: 'creatorReady'
    };

    var post = {{post|json|safe}} || null;

    $(function () {
        $.cloudinary.config({{cloudinary.config()|json|safe}});

        var editor = new MediumEditor('.editable', {
            buttonLabels: 'fontawesome',
            toolbar: {
              buttons: ['h2', 'h3', 'bold', 'italic', 'underline', 'strikethrough', 'quote', 'anchor', 'justifyLeft', 'justifyCenter', 'justifyRight', 'justifyFull','orderedlist', 'unorderedlist']
            }
        });

        $('.editable').mediumInsert({
            editor: editor
        });

        var uploadingImage = false;

        var $status = $('.status');

        Broadcaster.addEventListener('imageProgressComplete', function () {
            uploadingImage = true;
            $status.text('Procesando imagen....');
            console.log('started');
        });

        Broadcaster.addEventListener('imageStarted', function () {
            uploadingImage = true;
            $status.text('Cargando imagen....');
            console.log('started');
        });

        Broadcaster.addEventListener('imageLoaded', function () {
            uploadingImage = false;
            $status.text('Imagen cargada');
        });

        var triggerAutoSave = function (event, editable) {
            if (uploadingImage) return console.log('subiendo imagen');
            var payload = {body: editor.serialize()['element-0']['value']};

            $status.text('Guardando.....');
            if(!post) {
              var url = '/post/create';
              $.post(url, payload).then(function(response) {
                post = response.data.post;
              });
            } else {
              var url = '/post/update';
              payload.idPost = post.id;
              $.post(url, payload).then(function(response) {
                post = response.data.post;
                $status.text('âœ“ guardado');
              });
            }
        };

        var throttledAutoSave = MediumEditor.util.throttle(triggerAutoSave, 1000);
        editor.subscribe('editableInput', throttledAutoSave);
    });
</script>
</body>
</html>
