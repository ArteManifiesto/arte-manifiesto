{% extends '../../partials/base.html' %}
{% block elements %}
{% set work = work.toJSON() %}
	<div class="grid-container u-margin-top-30">
		<div class="grid-100">
			<div class="single-info">
				<div class="single-image">
					<div class="single-image-inner">
						<img src="{{work.photo|addFilter('w_500,h_800,q_80,c_limit')}}">
						<div class="actions u-padding-top-20 u-padding-bottom-20">
							<div class="action {% if work.liked %} active {% endif %}">
								<div class="like-btn">
									<i class="icon bi_ecommerce-diamon  valuation"></i>
									<p class="text">VALORAR</p>
								</div>
							</div>

							<div class="action">
								<div class="collect-btn">
									<i class="icon bi_interface-list-view valuation"></i>
									<p class="text">COLECCIONAR</p>
								</div>
								<div class="actions-box add-collection hide">
									<p class="title">Añadir a las colecciones</p>
									<div class="u-separator u-margin-top-7"></div>

									<form class="add-collection-form">
										<input class="u-margin-top-10" type="text" name='name' required placeholder="Crear una colección nueva">
										<button class="u-margin-top-10 color-black bg-gray wd-auto">AÑADIR</button>
									</form>
									<ul class="collections u-margin-top-20">
									</ul>
									<div class="u-separator u-margin-top-20"></div>
									<div class="buttons u-margin-top-20">
										<button class="wd-auto bg-blue color-white save-collections">GUARDAR</button>
									</div>
								</div>
							</div>
							<div class="action">
								<!-- <i class="icon fa fa-share-alt share"></i> -->
								<div class="share-btn">
									<i class="icon bi_web-share share"></i>
									<p class="text">COMPARTIR</p>
								</div>
								<div class="actions-box social-share hide">
									<p class="title">Compartir obras</p>
									<div class="u-separator u-margin-top-7"></div>
									<div class="share share-fb">
										<i class="fa fa-facebook"></i>Compartir en facebook
									</div>
									<div class="share share-tw">
										<i class="fa fa-twitter"></i>Compartir en twitter
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="single-data u-padding-bottom-40">
					<div class="FollowArtist u-padding-bottom-10">
						<div>
							<p class="u-padding-bottom-7 big uppercase"><strong>{{work.User.firstname}}</strong></p>
							<button class="am-Follow-button">+ SEGUIR</button>
						</div>
					</div>
					<div class="u-separator"></div>
					<p class="am-Single-title-text u-margin-top-15">{{work.description}}</p>
					<p class="am-Single-text u-margin-top-10">42 cm x 42 cm</p>
					<p class="am-Single-text u-margin-top-20">Categoría:</p>
					{% for category in work.Categories %}
						<a href='/works/category/{{category.nameSlugify}}/page-1/?order=popularity'><span class="am-Category-box u-margin-top-7">{{category.name}}</span></a>
					{% endfor %}
					<div class="info-box u-margin-top-25">
						<div class="header">
							<p class="selected">COMPRAR</p>
						</div>
						<div class="body u-text-center">
							<p class="title large">Puedes preguntar al artista la disponibilidad</p>
							<!-- <p class="price u-padding-top-10">S/. <strong class="large">1500</strong></p> -->
							<button class="am-View-button expand u-margin-top-20">PREGUNTAR PRECIO</button>
							<p class="msg u-padding-top-15 u-padding-bottom-4">Muy pronto la tienda en línea</p>
						</div>
					</div>
					<p class="am-stats-text u-margin-top-40">ESTADÍSTICAS</p>
					<div class="u-separator"></div>
					<div class="u-center">
						<table class="am-Single-stats u-margin-top-10">
						  <tr>
						    <!-- <td><i class="fa fa-eye"></i></td> -->
						    <td><i class="bi_interface-view"></i></td>
						    <td><p>VISTAS</p></td>
						    <td><span>{{work.views}}</span></td>
						  </tr>
						  <tr>
						    <!-- <td><i class="fa fa-diamond"></i></td> -->
						    <td><i class="bi_ecommerce-diamon"></i></td>
						    <td><p>VALORACIONES</p></td>
						    <td><span class="likes">{{work.likes || 0}}</span></td>
						  </tr>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>


	<!-- ********************************************************************
		$ SINGLE MENU
	********************************************************************* -->
	<div class="am-SingleMenu u-margin-top-20">
		<div class="grid-container">
			<div class="grid-100">
				<div class="single-menu">
					<div class="artist">
						<div class="FollowArtist">
							<a href="/user/{{work.User.username}}">
								<img src="{{work.User.photo}}">
							</a>
							<div>
								<p class="u-padding-bottom-4 uppercase" style="font-weight: bold;">{{work.User.firstname}}</p>
								<p class="u-padding-bottom-7"> <strong></strong> {{work.User.city}}, {{work.User.country}}</p>
								<button class="am-Follow-button">+ SEGUIR</button>
							</div>
						</div>
					</div>
					<div class="menu">
						<div class="carousel">
							<div class="single-tabs">
								<a href="/user/{{work.User.username}}/work/{{work.nameSlugify}}">
									<div class="single-tab index">
										<p>+ OBRAS</p>
										<!-- <i class="fa fa-cube"></i> -->
										<i class="bi_misc-cube"></i>
									</div>
								</a>
								<a href="/user/{{work.User.username}}/work/{{work.nameSlugify}}/reviews">
									<div class="single-tab reviews">
										<p>REVIEWS</p>
										<span>25</span>
									</div>
								</a>
								<a href="/user/{{work.User.username}}/work/{{work.nameSlugify}}/tags">
									<div class="single-tab tags">
										<p>TAGS</p>
										<!-- <i class="fa fa-align-left"></i> -->
										<i class="bi_editorial-left-align"></i>
									</div>
								</a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	{% if currentPath == 'reviews' %}
	<!-- ********************************************************************
		$ REVIEWS
	********************************************************************* -->
	<div class="grid-container">
		<div class="grid-100">
			<div class="reviews">
				<p class="title">Reviews &nbsp;&nbsp;<span>{{reviews.length}}</span></p>
				<div class='reviews-container'>
				</div>
				<div class="review">
					{% if user %}
						<div class="avatar"><img src="{{user.photo}}"></div>
						<form class="content review-form">
							<input type="hidden" name='idWork' value="{{work.id}}"/>
							<textarea class='value-input' name="value"></textarea>
							<button>ADD COMMENT</button>
						</form>
					{% else %}
						<a href="/auth/login">Logeate, para agregar review</a>
					{% endif %}
				</div>
			</div>
		</div>
	</div>

	{% endif %}

	<!-- ********************************************************************
		$ TAGS
	********************************************************************* -->
	{% if currentPath == 'tags' %}
		<div class="grid-container">
			<div class="grid-100">
				<div class="tags-container">
					<p class="title">Tags&nbsp;&nbsp;<span>25</span></p>
					<div class="u-separator"></div>
					<div class="tags">
						{% for tag in tags %}
						{% set url = "#" + tag.name %}
						<div class="tag uppercase"><a href='/works/category/all/page-1/?term={{url|url_encode}}'>{{tag.name}}</a></div>
						{% endfor %}
					</div>
				</div>
			</div>
		</div>
	{% endif %}


	<!-- ********************************************************************
		$ MORE WORKS
	********************************************************************* -->
	{% if currentPath == 'index' %}
		<div class="grid-container u-margin-top-60">
			<div class="grid-100">
				<p class="am-more-text u-text-center u-padding-bottom-10">Otras obras del artista</p>
				<div class="u-separator-center"></div>
			</div>
		</div>

		<div class="grid-container">
			<div class="grid-100">
				<div class="more-carousel">
					<div class="more-images more">
					</div>
				</div>
			</div>
		</div>

		<div class="u-separator u-margin-top-60"></div>

		<div class="grid-container u-margin-top-60">
			<div class="grid-100">
				<p class="am-more-text u-text-center u-padding-bottom-10">Obras relacionadas</p>
				<div class="u-separator-center"></div>
			</div>
		</div>

		<div class="grid-container">
			<div class="grid-100">
				<div class="more-carousel">
					<div class="more-images similar">
					</div>
				</div>
			</div>
		</div>
	{% endif %}

{% include '../../partials/report.html' %}

{% endblock %}

{% block scripts %}
	<script>
	var work = {{work|json|safe}};
	$(document).ready(function() {
		$('.share-btn').on('click',function(){
			$('.add-collection').hide();
			$('.social-share').toggle();
		});

		var following = false;
		var url = DataApp.currentUser.url + '/isFollowing';
		$.post(url, {idUser:work.User.id}, function (response) {
			if(response.status === 200) {
				following = response.data.following;
				if(response.data.following)
					$('.am-Follow-button').addClass('following').text('-Siguiendo');
			}
		});

		var url = DataApp.currentUser.url + '/collection/all';
		$.post(url, {}, function (response) {
			if(response.status === 200) {
				var collections = response.data.collections;
				var item = '<li class="collection" data-id="<%=id%>"><p><%=name%></p><i class="fa fa-check"></i></li>'
				for(var i= 0; i <collections.length; i++) {
					$('.collections').append($(_.template(item)(collections[i])));
				}

				var url = DataApp.currentUser.url + '/work/inside_collection';
				$.post(url, {idWork: work.id}, function (response) {
					var collections = response.data.collections;
					for(var i= 0; i <collections.length; i++) {
						var id = collections[i].id;
						$('.collection[data-id='+id+']').addClass('selected');
						collectionsClicked.push(id);
					}
				});
			}
		});

		$('.collect-btn').on('click',function() {
			$('.add-collection').toggle();
			$('.social-share').hide();
		});

		var currentPath = {{currentPath|json|safe}};
		if(currentPath === 'reviews') {
			var reviews = {{reviews|json|safe}};

			for(var i = 0; i <reviews.length; i++) {
				$('.reviews-container').append(new APP.Review(reviews[i]).view);
			}
		}

		new APP.Viewer('carrouselItem', $('.more'), null, {{more|json|safe}});
		new APP.Viewer('carrouselItem', $('.similar'), null, {{similar|json|safe}});

		$('.am-Follow-button').click(function(event){
			if(following) {
				var url = DataApp.currentUser.url + '/unfollow/';
				$.post(url,{idUser: work.User.id}, function (response) {
					if(response.status === 200) {
						following = false;
						$('.am-Follow-button').removeClass('following').text('+Seguir');
					}
				});
			}else {
				var url = DataApp.currentUser.url + '/follow/';
				$.post(url,{idUser: work.User.id}, function (response) {
					if(response.status === 200) {
						following = true;
						$('.am-Follow-button').addClass('following').text('-Siguiendo');
					}
				});
			}
		});

		$('.add-collection-form').submit(function(event){
			event.preventDefault();
			var url = DataApp.currentUser.url + '/collection/create';
			$.post(url, $(this).serialize(), function (response) {
				if(response.status === 200) {
					var item = '<li class="collection selected" data-id="<%=id%>"><p><%=name%></p><i class="fa fa-check"></i></li>'
					var collection = response.data.collection;
					collectionsClicked.push(collection.id);
					$('.collections').append($(_.template(item)(collection)));
				}
			});
		});

		$('.like-btn').click(function(){
			if(!work.liked) {
				var url = DataApp.currentUser.url + '/work/like';
				$.post(url, {idWork:work.id}, function (response) {
					if(response.status === 200) {
						work.liked = true;
						$('.likes').text(response.data.likes)
						$('.like-btn').parent().addClass('active');
					}
				});
			}else {
				var url = DataApp.currentUser.url + '/work/unlike';
				$.post(url, {idWork:work.id}, function (response) {
					work.liked = false;
					$('.likes').text(response.data.likes)
					if(response.status === 200) {
						$('.like-btn').parent().removeClass('active');
					}
				});
			}
		});

		$('.review-form').submit(function(event){
			event.preventDefault();
			var url = DataApp.currentUser.url + '/work/review/create';
			$.post(url, $(this).serialize(), function (response) {
				console.log(response);
				if(response.status === 200) {
					$('.value-input').val('');
					$('.reviews-container').append(new APP.Review(response.data.review).view);
				}
			});
		});

		var collectionsClicked = [];
		$('.collections').on("click", ".collection", function() {
			var id = parseInt($(this).data('id'),10);
			var index = collectionsClicked.indexOf(id);
			if(index === -1){
					collectionsClicked.push(id);
					$(this).addClass('selected');
			}else {
				collectionsClicked.splice(index, 1);
				$(this).removeClass('selected');
			}
		});

		$('.save-collections').click(function(){
			var url = DataApp.currentUser.url + '/work/add_to_collection';
			$.post(url, {idWork: work.id, collections: JSON.stringify(collectionsClicked)}, function (response) {
				console.log(response);
			});
		});
	});
	</script>
{% endblock %}
