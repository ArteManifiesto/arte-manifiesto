{% extends '../partials/base.html' %}

{% block elements %}

	<a id="go-collection-modal" href="#collection-modal"></a>
	<a id="go-share-modal" href="#share-modal"></a>

	<div id="collection-modal" style="display:none;">
		<i class="closed-modal fa fa-times"></i>
		<div class="actions-box add-collection">
			<p class="title">Añadir a las colecciones</p>
			<div class="u-separator u-margin-top-7"></div>

			<form class="add-collection-form">
				<input class="u-margin-top-10" type="text" name='name' required placeholder="Crear una colección nueva">
				<button class="u-margin-top-10 color-black bg-gray wd-auto">AÑADIR</button>
			</form>
			<ul class="collections u-margin-top-20">
			</ul>
			<div class="u-separator u-margin-top-20"></div>
			<div class="buttons u-margin-top-20">
				<button class="wd-auto bg-blue color-white save-collections">GUARDAR</button>
				<div class="hide save-collections-loading">
					<button class="wd-auto bg-blue color-white">
						<i class="load fa fa-spinner"></i>
					</button>
				</div>
			</div>
		</div>
	</div>

	<div id="share-modal" style="display:none;">
		<i class="closed-modal fa fa-times"></i>
		<div class="actions-box social-share">
			<p class="title">Compartir obras</p>
			<div class="u-separator u-margin-top-7"></div>
			<div class="share share-fb">
				<i class="fa fa-facebook"></i>Compartir en facebook
			</div>
			<div class="share share-tw">
				<i class="fa fa-twitter"></i>Compartir en twitter
			</div>
		</div>
	</div>

	<div class="feed">
		<div class="feed-title">
			<div class="title">ART FEED</div>
			<div class="u-separator" style="background: #eee;"></div>
			<div class="user-info">
				<div class="avatar">
					<img src="{{user.photo}}">
					<div class="info">
						<p class="name uppercase">{{user.firstname}} <br> {{user.lastname}}</p>
						<p class="city u-margin-top-5">{{user.city}}, {{user.country}}</p>
					</div>
				</div>
				<div class="stats">
					<a href="/user/{{user.username}}/followers">
						<div class="stat">
							<p>{{numbers[0]}}</p>
							<p class="u-margin-top-7">seguidores</p>
						</div>
					</a>
					<a href="/user/{{user.username}}/">
						<div class="stat">
							<p>{{numbers[1]}}</p>
							<p class="u-margin-top-7">obras</p>
						</div>
					</a>
					<a href="/user/{{user.username}}/followings">
						<div class="stat">
							<p>{{numbers[2]}}</p>
							<p class="u-margin-top-7">siguiendo</p>
						</div>
					</a>
				</div>
			</div>
		</div>
		<div class="feed-title" style="margin-top: 20px;">
			<div class="title">Todavía no sigues a nadie, pero te sugerimos a los últimos artistas destacados de AM</div>
		</div>
		<div class="feed-inner">
			<div class="am-More-preload loading hide"><i class="fa fa-spinner"></i></div>
		</div>
	</div>


{% endblock %}


{% block scripts %}
	<script>
	var collections = [];
	var currentIdWork = null;
	$(function(){
		console.log({{data|json|safe}});
		new APP.Viewer('actionItem', $('.feed-inner'), 'infinite', {{data|json|safe}});
		var url = DataApp.currentUser.url + '/collection/all';
	  $.post(url, {}, function (response) {
	    if(response.status === 200) {
	    collections = response.data.collections;
	      var item = '<li class="collection" data-id="<%=id%>"><p><%=name%></p><i class="fa fa-check"></i></li>'
	      for(var i= 0; i <collections.length; i++) {
	        $('.collections').append($(_.template(item)(collections[i])));
	      }
	    }
	  });

		$('.collections').on("click", ".collection", function() {
	    var id = parseInt($(this).data('id'),10);
	    var index = collections.indexOf(id);
	    if(index === -1) {
	        collections.push(id);
	        $(this).addClass('selected');
	    }else {
	      collections.splice(index, 1);
	      $(this).removeClass('selected');
	    }
	  });

		$('.save-collections').click(function() {
	    $(this).hide();
	    $('.save-collections-loading').show();
	    var url = DataApp.currentUser.url + '/work/add_to_collection';
	    var payload = {collections: JSON.stringify(collections), idWork: currentIdWork};
	    $.post(url, payload, function (response) {
	      if(response.status === 200) {
	        $('.save-collections-loading').hide();
	        $('.save-collections').show();
	        $('#lean_overlay').trigger( "click" );
	      }
	    });
	  });

		$('.add-collection-form').submit(function(event){
	    event.preventDefault();
	    var url = DataApp.currentUser.url + '/collection/create';
	    $.post(url, $(this).serialize(), function (response) {
	      if(response.status === 200) {
	        var item = '<li class="collection" data-id="<%=id%>"><p><%=name%></p><i class="fa fa-check"></i></li>'
	        $('.collections').append($(_.template(item)(response.data.collection)));
	      }
	    });
	  });

		$("#go-collection-modal").leanModal();
		$("#go-share-modal").leanModal();
	})
	</script>
{% endblock %}
